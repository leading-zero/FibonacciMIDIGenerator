<!DOCTYPE html>
<html>
<head>
    <title>Fibonacci MIDI Sequence</title>
    <link rel='stylesheet' type='text/css' href='css/styles.css'>
</head>
<body>
<div>
    <h1>Fibonacci MIDI Sequence Generator</h1>
    <p>Enter the first two numbers of the Fibonacci sequence and the starting index:</p>
    <form>
        <label for="fib1">First number:</label>
        <input type="number" id="fib1" name="fib1" min="1" max="127">
        <br><br>
        <label for="fib2">Second number:</label>
        <input type="number" id="fib2" name="fib2" min="1" max="127">
        <br><br>
        <label for="index">Starting index (0 - 15):</label>
        <input type="number" id="index" name="index" min="0" max="15">
        <br><br>
        <input type="button" value="Generate MIDI" onclick="generateMidi()">
        <input type="button" value="Save MIDI" onclick="saveMidi(notes)">
    </form>
    <p>Drag the file into your DAW then adjust the sequence to make some tunes.</p>
    <p>The notes will be generated in the lowest octave, so you might want to pitch them up.</p>
    <script src='./node_modules/midi-writer-js/browser/midiwriter.js'></script>
</div>

<script>
  let notes = []; // declare notes array as a global variable

  function generateMidi() {
    const fib1 = parseInt(document.getElementById("fib1").value);
    const fib2 = parseInt(document.getElementById("fib2").value);
    const index = parseInt(document.getElementById("index").value);
    let fibonacciSequence = [fib1, fib2];

    // generate a Fibonacci sequence of 16 numbers
    for (let i = 2; i < 16; i++) {
      fibonacciSequence.push(fibonacciSequence[i-1] + fibonacciSequence[i-2]);
    }
    console.log(fibonacciSequence);

    const noteLengths = fibonacciSequence.slice(0, 16);
    let fibonacciIndex = index;

    // Loop through each note length in the noteLengths array
    for (let i = 0; i < noteLengths.length; i++) {
      // Determine the note duration based on the current note length
      let noteDuration = noteLengths[i] % 4 === 0 ? 4 : noteLengths[i] % 2 === 0 ? 2 : 1;
      // Determine the note pitch based on the current fibonacci index
      let notePitch = fibonacciSequence[fibonacciIndex] % 12 + 1;
      // Create a new MidiWriter NoteEvent object with the note pitch and duration
      const note = new MidiWriter.NoteEvent({ pitch: [notePitch], duration: noteDuration });
      // Add the new note to the notes array
      notes.push(note);
      // Increment the fibonacci index for the next note pitch
      fibonacciIndex = (fibonacciIndex + 1) % fibonacciSequence.length;
    }

    console.log(notes);
  }

  function saveMidi() {
    console.log(notes);
    //generateMidi(); // call generateMidi() to populate the notes array
    const track = new MidiWriter.Track();
    const tempo = new MidiWriter.TempoEvent({ bpm: 170 });

    track.addEvent(tempo);
    track.addEvent(new MidiWriter.ProgramChangeEvent({ instrument: 1 }));
    track.addEvent(notes, function(event, index) { // access the notes array
      if (event.name === 'Note On') {
        event.setVelocity(100);
      }
    });

    const write = new MidiWriter.Writer([track]);
    const base64String = write.base64();
    const downloadLink = document.createElement('a');
    downloadLink.href = 'data:audio/midi;base64,' + base64String;
    downloadLink.download = 'output.mid';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
  }

</script>
